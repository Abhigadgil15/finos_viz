{"version":3,"sources":["../../../src/js/workspace/workspace.js"],"names":["find","toArray","Panel","PerspectiveDockPanel","Menu","MenuRenderer","createCommands","PerspectiveViewerWidget","uniqBy","debounce","cloneDeep","DiscreteSplitPanel","DEFAULT_WORKSPACE_SIZE","ID_COUNTER","SIDE","LEFT","RIGHT","MODE","GLOBAL_FILTERS","LINKED","ObservableMap","Map","set","name","item","_set_listener","get","delete","result","_delete_listener","addSetListener","listener","addDeleteListener","PerspectiveWorkspace","constructor","element","options","orientation","event","config","target","save","type","plugin","candidates","Set","filters","map","x","detail","mode","_linkedViewers","forEach","viewer","_filterViewer","dockpanel","widgets","widget","_save","_fireUpdateEvent","addClass","enableContextMenu","detailPanel","layout","fitPolicy","addWidget","masterPanel","layoutModified","connect","workspaceUpdated","_side","side","listeners","WeakMap","_tables","bind","commands","menuRenderer","customCommands","addTable","table","tables","getTable","removeTable","value","toUpperCase","undefined","console","warn","isAttached","newSizes","relativeSizes","slice","reverse","close","setRelativeSizes","sizes","mapWidgets","getAttribute","saveLayout","master","viewers","restore","viewer_configs","length","setupMasterPanel","_capture_viewers","_capture_widgets","callback","_restore_callback","detailLayout","restoreLayout","getAllWidgets","node","isConnected","Array","from","children","ending_widgets","indexOf","removeChild","starting_viewers","starting_widgets","widgetName","viewer_config","slot","_createWidget","_createWidgetAndNode","error","addEventListener","onPerspectiveSelect","linked","_linkWidget","_validate","view","Error","then","load","isUsed","some","update_widget_for_viewer","slot_name","_gen_id","setAttribute","table_name","querySelector","outerHTML","activateWidget","remove_unslotted_widgets","missing","duplicate","toggleSingleDocument","index","insertWidget","ref","toggleMasterDetail","isGlobalFilter","parent","dispatchEvent","CustomEvent","makeDetail","makeMaster","_maximize","classList","add","_minimizedLayout","_maximizedWidget","notifyResize","_unmaximize","remove","availableColumns","Object","keys","schema","currentFilters","columnAvailable","filter","includes","validFilters","push","has","newFilters","hasAttribute","toggleConfig","isHidden","show","restyleElement","removeEventListener","isLinked","title","className","selectable","toggleLink","replace","createContextMenu","contextMenu","renderer","addItem","command","args","showContextMenu","menu","tabbar","tabBars","bar","currentTitle","owner","contains","_menu_opened","aboutToClose","removeClass","open","clientX","clientY","preventDefault","stopPropagation","clearLayout","_addContextMenuItem","id","addCommand","execute","label","isVisible","mnemonic","addViewer","update","slotname","_createNode","document","createElement","genId","div","appendChild","parentElement","closable","_addWidgetEventListeners","settings","updated","changed","disconnect","key"],"mappings":"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","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2018, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport {find, toArray} from \"@lumino/algorithm\";\nimport {Panel} from \"@lumino/widgets\";\nimport {PerspectiveDockPanel} from \"./dockpanel\";\nimport {Menu} from \"@lumino/widgets\";\nimport {MenuRenderer} from \"./menu\";\nimport {createCommands} from \"./commands\";\n\nimport {PerspectiveViewerWidget} from \"./widget\";\nimport uniqBy from \"lodash/uniqBy\";\nimport debounce from \"lodash/debounce\";\nimport cloneDeep from \"lodash/cloneDeep\";\nimport {DiscreteSplitPanel} from \"./discrete\";\n\nconst DEFAULT_WORKSPACE_SIZE = [1, 3];\n\nlet ID_COUNTER = 0;\n\nexport const SIDE = {\n    LEFT: \"left\",\n    RIGHT: \"right\"\n};\n\nexport const MODE = {\n    GLOBAL_FILTERS: \"globalFilters\",\n    LINKED: \"linked\"\n};\n\nclass ObservableMap extends Map {\n    set(name, item) {\n        this._set_listener?.(name, item);\n        super.set(name, item);\n    }\n\n    get(name) {\n        return super.get(name);\n    }\n\n    delete(name) {\n        const result = this._delete_listener?.(name);\n        if (result) {\n            return super.delete(name);\n        } else {\n            return false;\n        }\n    }\n\n    addSetListener(listener) {\n        this._set_listener = listener;\n    }\n\n    addDeleteListener(listener) {\n        this._delete_listener = listener;\n    }\n}\n\nexport class PerspectiveWorkspace extends DiscreteSplitPanel {\n    constructor(element, options = {}) {\n        super({orientation: \"horizontal\"});\n\n        this.addClass(\"perspective-workspace\");\n        this.dockpanel = new PerspectiveDockPanel(\"main\", {enableContextMenu: false});\n        this.detailPanel = new Panel();\n        this.detailPanel.layout.fitPolicy = \"set-no-constraint\";\n        this.detailPanel.addClass(\"perspective-scroll-panel\");\n        this.detailPanel.addWidget(this.dockpanel);\n        this.masterPanel = new DiscreteSplitPanel({orientation: \"vertical\"});\n        this.masterPanel.addClass(\"master-panel\");\n\n        this.dockpanel.layoutModified.connect(() => this.workspaceUpdated());\n        this.masterPanel.layoutModified.connect(() => this.workspaceUpdated());\n        this.layoutModified.connect(() => this.workspaceUpdated());\n\n        this.addWidget(this.detailPanel);\n\n        this.element = element;\n        this._side = options.side || SIDE.LEFT;\n        this.mode = options.mode || MODE.GLOBAL_FILTERS;\n        this._linkedViewers = [];\n\n        this.listeners = new WeakMap();\n        this._tables = new ObservableMap();\n        this._tables.addSetListener(this._set_listener.bind(this));\n        this._tables.addDeleteListener(this._delete_listener.bind(this));\n        this.commands = createCommands(this);\n        this.menuRenderer = new MenuRenderer(this.element);\n\n        this.customCommands = [];\n    }\n\n    /***************************************************************************\n     *\n     * `<perspective-workspace>` Public API\n     *\n     */\n\n    addTable(name, table) {\n        this.tables.set(name, table);\n    }\n\n    getTable(name) {\n        return this.tables.get(name);\n    }\n\n    removeTable(name) {\n        return this.tables.delete(name);\n    }\n\n    get tables() {\n        return this._tables;\n    }\n\n    set side(value) {\n        if (SIDE[value.toUpperCase()] === undefined) {\n            console.warn(\"Unknown `side` attribute:\", value);\n            return;\n        }\n\n        if (this._side !== value && this.masterPanel.isAttached) {\n            const newSizes = this.relativeSizes()\n                .slice()\n                .reverse();\n\n            this.detailPanel.close();\n            this.masterPanel.close();\n\n            if (value === SIDE.LEFT) {\n                this.addWidget(this.masterPanel);\n                this.addWidget(this.detailPanel);\n            } else {\n                this.addWidget(this.detailPanel);\n                this.addWidget(this.masterPanel);\n            }\n            this.setRelativeSizes(newSizes);\n        }\n        this._side = value;\n    }\n\n    get side() {\n        return this._side;\n    }\n\n    save() {\n        const layout = {\n            sizes: [...this.relativeSizes()],\n            detail: PerspectiveDockPanel.mapWidgets(widget => widget.viewer.getAttribute(\"slot\"), this.dockpanel.saveLayout()),\n            mode: this.mode\n        };\n        if (this.masterPanel.isAttached) {\n            const master = {\n                widgets: this.masterPanel.widgets.map(widget => widget.viewer.getAttribute(\"slot\")),\n                sizes: [...this.masterPanel.relativeSizes()]\n            };\n            layout.master = master;\n        }\n        const viewers = {};\n        for (const widget of this.masterPanel.widgets) {\n            viewers[widget.viewer.getAttribute(\"slot\")] = widget.save();\n        }\n        PerspectiveDockPanel.mapWidgets(widget => {\n            viewers[widget.viewer.getAttribute(\"slot\")] = widget.save();\n        }, this.dockpanel.saveLayout());\n        return {...layout, viewers};\n    }\n\n    restore(value) {\n        const {sizes, master, detail, viewers: viewer_configs = [], mode = MODE.GLOBAL_FILTERS} = cloneDeep(value);\n        this.mode = mode;\n\n        if (this.mode === MODE.GLOBAL_FILTERS && master && master.widgets.length > 0) {\n            this.setupMasterPanel(sizes || DEFAULT_WORKSPACE_SIZE);\n        } else {\n            if (this.masterPanel.isAttached) {\n                this.masterPanel.close();\n            }\n\n            this.addWidget(this.detailPanel);\n        }\n\n        // Using ES generators as context managers ..\n        for (const viewers of this._capture_viewers()) {\n            for (const widgets of this._capture_widgets()) {\n                const callback = this._restore_callback.bind(this, viewer_configs, viewers, widgets);\n\n                if (detail) {\n                    const detailLayout = PerspectiveDockPanel.mapWidgets(callback.bind(this, false), detail);\n                    this.dockpanel.restoreLayout(detailLayout);\n                }\n\n                if (master) {\n                    if (this.mode === MODE.GLOBAL_FILTERS) {\n                        master.widgets.forEach(callback.bind(this, true));\n                        master.sizes && this.masterPanel.setRelativeSizes(master.sizes);\n                    } else {\n                        master.widgets.forEach(config => {\n                            const widget = callback.bind(this, undefined)(config);\n                            this.dockpanel.addWidget(widget);\n                        });\n                    }\n                }\n            }\n        }\n    }\n\n    *_capture_widgets() {\n        const widgets = this.getAllWidgets();\n        yield widgets;\n        for (const widget of widgets) {\n            if (!widget.node.isConnected) {\n                widget.close();\n            }\n        }\n    }\n\n    *_capture_viewers() {\n        const viewers = Array.from(this.element.children);\n        yield viewers;\n        const ending_widgets = this.getAllWidgets();\n        for (const viewer of viewers) {\n            let widget = ending_widgets.find(x => x.viewer === viewer);\n            if (!widget && Array.from(this.element.children).indexOf(viewer) > -1) {\n                this.element.removeChild(viewer);\n                viewer.delete();\n            }\n        }\n    }\n\n    _restore_callback(viewers, starting_viewers, starting_widgets, master, widgetName) {\n        let viewer_config;\n        if (typeof widgetName === \"string\") {\n            viewer_config = viewers[widgetName];\n        } else {\n            viewer_config = widgetName;\n            widgetName = viewer_config.slot;\n        }\n        let viewer = !!widgetName && starting_viewers.find(x => x.getAttribute(\"slot\") === widgetName);\n        let widget;\n        if (viewer) {\n            widget = starting_widgets.find(x => x.viewer === viewer);\n            if (widget) {\n                widget.restore({...viewer_config, master});\n            } else {\n                widget = this._createWidget({\n                    config: {...viewer_config, master},\n                    viewer\n                });\n            }\n        } else if (viewer_config) {\n            widget = this._createWidgetAndNode({\n                config: {...viewer_config, master},\n                slot: widgetName\n            });\n        } else {\n            console.error(`Could not find or create <perspective-viewer> for slot \"${widgetName}\"`);\n        }\n        if (master || this.mode === MODE.LINKED) {\n            widget.viewer.addEventListener(\"perspective-select\", this.onPerspectiveSelect);\n            widget.viewer.addEventListener(\"perspective-click\", this.onPerspectiveSelect);\n            // TODO remove event listener\n            this.masterPanel.addWidget(widget);\n        }\n\n        if (widget.linked) {\n            this._linkWidget(widget);\n        }\n        return widget;\n    }\n\n    _validate(table) {\n        if (!(\"view\" in table) || typeof table?.view !== \"function\") {\n            throw new Error(\"Only `perspective.Table()` instances can be added to `tables`\");\n        }\n        return table;\n    }\n\n    _set_listener(name, table) {\n        if (typeof table?.then === \"function\") {\n            table = table.then(this._validate);\n        } else {\n            this._validate(table);\n        }\n        this.getAllWidgets().forEach(widget => {\n            if (widget.viewer.getAttribute(\"table\") === name) {\n                widget.viewer.load(table);\n            }\n        });\n    }\n\n    _delete_listener(name) {\n        const isUsed = this.getAllWidgets().some(widget => widget.viewer.getAttribute(\"table\") === name);\n        if (isUsed) {\n            console.error(`Cannot remove table: '${name}' because it's still bound to widget(s)`);\n            return false;\n        }\n        return true;\n    }\n\n    update_widget_for_viewer(viewer) {\n        let slot_name = viewer.getAttribute(\"slot\");\n        if (!slot_name) {\n            slot_name = this._gen_id();\n            viewer.setAttribute(\"slot\", slot_name);\n        }\n        const table_name = viewer.getAttribute(\"table\");\n        if (table_name) {\n            const slot = this.node.querySelector(`slot[name=${slot_name}]`);\n            if (!slot) {\n                //const name = viewer.getAttribute(\"name\");\n                console.warn(`Undocked ${viewer.outerHTML}, creating default layout`);\n                const widget = this._createWidget({\n                    name: viewer.getAttribute(\"name\"),\n                    table: this.tables.get(viewer.getAttribute(\"table\")),\n                    config: {master: false},\n                    viewer\n                });\n                this.dockpanel.addWidget(widget);\n                this.dockpanel.activateWidget(widget);\n            }\n        } else {\n            console.warn(`No table set for ${viewer.outerHTML}`);\n        }\n    }\n\n    remove_unslotted_widgets(viewers) {\n        const widgets = this.getAllWidgets();\n        for (const widget of widgets) {\n            let missing = viewers.indexOf(widget.viewer) === -1;\n            if (missing) {\n                widget.close();\n            }\n        }\n    }\n\n    /***************************************************************************\n     *\n     * Workspace-level contextmenu actions\n     *\n     */\n\n    duplicate(widget) {\n        if (this.dockpanel.mode === \"single-document\") {\n            this.toggleSingleDocument(widget);\n        }\n        const config = widget.save();\n        config.name = config.name ? `${config.name} (duplicate)` : \"\";\n        const duplicate = this._createWidgetAndNode({config});\n        if (config.linked) {\n            this._linkWidget(duplicate);\n        }\n        if (widget.master) {\n            const index = this.masterPanel.widgets.indexOf(widget) + 1;\n            this.masterPanel.insertWidget(index, duplicate);\n        } else {\n            this.dockpanel.addWidget(duplicate, {mode: \"split-right\", ref: widget});\n        }\n    }\n\n    toggleMasterDetail(widget) {\n        const isGlobalFilter = widget.parent !== this.dockpanel;\n\n        this.element.dispatchEvent(\n            new CustomEvent(\"workspace-toggle-global-filter\", {\n                detail: {\n                    widget,\n                    isGlobalFilter: !isGlobalFilter\n                }\n            })\n        );\n\n        if (isGlobalFilter) {\n            this.makeDetail(widget);\n        } else {\n            if (this.dockpanel.mode === \"single-document\") {\n                this.toggleSingleDocument(widget);\n            }\n            this.makeMaster(widget);\n        }\n    }\n\n    _maximize(widget) {\n        widget.viewer.classList.add(\"widget-maximize\");\n        this._minimizedLayout = this.dockpanel.saveLayout();\n        this._maximizedWidget = widget;\n        this.dockpanel.mode = \"single-document\";\n        this.dockpanel.activateWidget(widget);\n        widget.notifyResize();\n    }\n\n    _unmaximize() {\n        this._maximizedWidget.viewer.classList.remove(\"widget-maximize\");\n        this.dockpanel.mode = \"multiple-document\";\n        this.dockpanel.restoreLayout(this._minimizedLayout);\n    }\n\n    toggleSingleDocument(widget) {\n        if (this.dockpanel.mode !== \"single-document\") {\n            this._maximize(widget);\n        } else {\n            this._unmaximize();\n        }\n    }\n\n    async _filterViewer(viewer, filters, candidates) {\n        const config = viewer.save();\n        const availableColumns = Object.keys(await viewer.table.schema());\n        const currentFilters = config.filters || [];\n        const columnAvailable = filter => filter[0] && availableColumns.includes(filter[0]);\n        const validFilters = filters.filter(columnAvailable);\n\n        validFilters.push(...currentFilters.filter(x => !candidates.has(x[0])));\n        const newFilters = uniqBy(validFilters, item => item[0]);\n        viewer.restore({filters: newFilters});\n    }\n\n    onPerspectiveSelect = event => {\n        const config = event.target.save();\n        // perspective-select is already handled for hypergrid\n\n        if (event.type === \"perspective-click\" && config.plugin === \"datagrid\") {\n            return;\n        }\n        const candidates = new Set([...(config[\"row-pivots\"] || []), ...(config[\"column-pivots\"] || []), ...(config.filters || []).map(x => x[0])]);\n        const filters = [...event.detail.config.filters];\n\n        if (this.mode === MODE.LINKED) {\n            this._linkedViewers.forEach(viewer => {\n                if (viewer !== event.target) {\n                    this._filterViewer(viewer, filters, candidates);\n                }\n            });\n        } else {\n            toArray(this.dockpanel.widgets()).forEach(widget => this._filterViewer(widget.viewer, filters, candidates));\n        }\n    };\n\n    async makeMaster(widget) {\n        widget.master = true;\n\n        if (widget.viewer.hasAttribute(\"settings\")) {\n            await widget.toggleConfig();\n        }\n\n        if (!this.masterPanel.isAttached) {\n            this.detailPanel.close();\n            this.setupMasterPanel(DEFAULT_WORKSPACE_SIZE);\n        }\n\n        this.masterPanel.addWidget(widget);\n        widget.isHidden && widget.show();\n\n        widget.viewer.restyleElement();\n        widget.viewer.addEventListener(\"perspective-click\", this.onPerspectiveSelect);\n        widget.viewer.addEventListener(\"perspective-select\", this.onPerspectiveSelect);\n    }\n\n    makeDetail(widget) {\n        widget.master = false;\n\n        this.dockpanel.addWidget(widget, {mode: `split-${this._side}`});\n\n        if (this.masterPanel.widgets.length === 0) {\n            this.detailPanel.close();\n            this.masterPanel.close();\n            this.addWidget(this.detailPanel);\n        }\n\n        widget.viewer.restyleElement();\n        widget.viewer.removeEventListener(\"perspective-click\", this.onPerspectiveSelect);\n        widget.viewer.removeEventListener(\"perspective-select\", this.onPerspectiveSelect);\n    }\n\n    isLinked(widget) {\n        return this._linkedViewers.indexOf(widget.viewer) > -1;\n    }\n\n    _linkWidget(widget) {\n        widget.title.className += \" linked\";\n        if (this._linkedViewers.indexOf(widget.viewer) === -1) {\n            this._linkedViewers.push(widget.viewer);\n            // if this is the first linked viewer, make viewers with\n            // row-pivots selectable\n            if (this._linkedViewers.length === 1) {\n                this.getAllWidgets().forEach(widget => {\n                    const config = widget.viewer.save();\n                    if (config[\"row-pivots\"]) {\n                        widget.viewer.restore({selectable: true});\n                    }\n                });\n            }\n        }\n    }\n\n    toggleLink(widget) {\n        widget.linked = !widget.linked;\n        if (widget.linked) {\n            this._linkWidget(widget);\n        } else {\n            widget.title.className = widget.title.className.replace(/ linked/g, \"\");\n            this._linkedViewers = this._linkedViewers.filter(viewer => viewer !== widget.viewer);\n            if (this._linkedViewers.length === 0) {\n                this.getAllWidgets().forEach(widget => widget.viewer.restore({selectable: false}));\n            }\n        }\n    }\n\n    /***************************************************************************\n     *\n     * Context Menu\n     *\n     */\n\n    createContextMenu(widget) {\n        const contextMenu = new Menu({commands: this.commands, renderer: this.menuRenderer});\n\n        contextMenu.addItem({command: \"workspace:maximize\", args: {widget}});\n        contextMenu.addItem({command: \"workspace:minimize\", args: {widget}});\n        contextMenu.addItem({command: \"workspace:duplicate\", args: {widget}});\n        contextMenu.addItem({command: \"workspace:master\", args: {widget}});\n        contextMenu.addItem({command: \"workspace:link\", args: {widget}});\n\n        contextMenu.addItem({type: \"separator\"});\n\n        contextMenu.addItem({command: \"workspace:export\", args: {widget}});\n        contextMenu.addItem({command: \"workspace:copy\", args: {widget}});\n        contextMenu.addItem({command: \"workspace:reset\", args: {widget}});\n\n        contextMenu.addItem({type: \"separator\"});\n\n        contextMenu.addItem({command: \"workspace:close\", args: {widget}});\n\n        if (this.customCommands.length > 0) {\n            contextMenu.addItem({type: \"separator\"});\n            this.customCommands.forEach(command => {\n                contextMenu.addItem({command, args: {widget}});\n            });\n        }\n        return contextMenu;\n    }\n\n    showContextMenu(widget, event) {\n        const menu = this.createContextMenu(widget);\n        const tabbar = find(this.dockpanel.tabBars(), bar => bar.currentTitle.owner === widget);\n\n        widget.addClass(\"context-focus\");\n        widget.viewer.classList.add(\"context-focus\");\n        tabbar && tabbar.node.classList.add(\"context-focus\");\n        this.element.classList.add(\"context-menu\");\n        this.addClass(\"context-menu\");\n\n        if (widget.viewer.classList.contains(\"workspace-master-widget\")) {\n            menu.node.classList.add(\"workspace-master-menu\");\n        } else {\n            menu.node.classList.remove(\"workspace-master-menu\");\n        }\n        this._menu_opened = true;\n\n        menu.aboutToClose.connect(() => {\n            this.element.classList.remove(\"context-menu\");\n            this.removeClass(\"context-menu\");\n            widget.removeClass(\"context-focus\");\n            tabbar?.node?.classList.remove(\"context-focus\");\n        });\n\n        menu.open(event.clientX, event.clientY);\n        event.preventDefault();\n        event.stopPropagation();\n    }\n\n    /***************************************************************************\n     *\n     * Context Menu\n     *\n     */\n\n    clearLayout() {\n        this.getAllWidgets().forEach(widget => widget.close());\n        this.widgets.forEach(widget => widget.close());\n        this.detailPanel.close();\n        this._linkedViewers = [];\n\n        if (this.masterPanel.isAttached) {\n            this.masterPanel.close();\n        }\n    }\n\n    setupMasterPanel(sizes) {\n        if (this.side === SIDE.RIGHT) {\n            this.addWidget(this.detailPanel);\n            this.addWidget(this.masterPanel);\n            this.setRelativeSizes(sizes.slice().reverse());\n        } else {\n            this.addWidget(this.masterPanel);\n            this.addWidget(this.detailPanel);\n            this.setRelativeSizes(sizes);\n        }\n    }\n\n    _addContextMenuItem(item) {\n        this.customCommands.push(item.id);\n        this.commands.addCommand(item.id, {\n            execute: args => item.execute({widget: args.widget}),\n            label: item.label,\n            isVisible: args => item.isVisible({widget: args.widget}),\n            mnemonic: 0\n        });\n    }\n\n    addViewer(config) {\n        const widget = this._createWidgetAndNode({config});\n        if (this.dockpanel.mode === \"single-document\") {\n            this.toggleSingleDocument();\n        }\n        if (config.master) {\n            if (!this.masterPanel.isAttached) {\n                this.setupMasterPanel(DEFAULT_WORKSPACE_SIZE);\n            }\n            this.masterPanel.addWidget(widget);\n        } else {\n            if (!this.detailPanel.isAttached) {\n                this.addWidget(this.detailPanel);\n            }\n            this.dockpanel.addWidget(widget, {mode: \"split-right\"});\n        }\n        this.update();\n    }\n\n    /*********************************************************************\n     * Widget helper methods\n     */\n\n    _createWidgetAndNode({config, slot: slotname}) {\n        const node = this._createNode(slotname);\n        const table = config.table;\n        const viewer = document.createElement(\"perspective-viewer\");\n        viewer.setAttribute(\"slot\", node.querySelector(\"slot\").getAttribute(\"name\"));\n        if (table) {\n            viewer.setAttribute(\"table\", table);\n        }\n        return this._createWidget({config, node, viewer});\n    }\n\n    _gen_id() {\n        let genId = `PERSPECTIVE_GENERATED_ID_${ID_COUNTER++}`;\n        if (this.element.querySelector(`[slot=${genId}]`)) {\n            genId = this._gen_id();\n        }\n        return genId;\n    }\n\n    _createNode(slotname) {\n        let node = this.node.querySelector(`slot[name=${slotname}]`);\n        if (!node) {\n            const slot = document.createElement(\"slot\");\n            slotname = slotname || this._gen_id();\n            slot.setAttribute(\"name\", slotname);\n            const div = document.createElement(\"div\");\n            div.classList.add(\"viewer-container\");\n            div.appendChild(slot);\n            node = document.createElement(\"div\");\n            node.classList.add(\"workspace-widget\");\n            node.appendChild(div);\n        } else {\n            node = node.parentElement.parentElement;\n        }\n        return node;\n    }\n\n    _createWidget({config, node, viewer}) {\n        config.name = config.name || viewer.getAttribute(\"name\");\n        if (!node) {\n            const slotname = viewer.getAttribute(\"slot\");\n            node = this.node.querySelector(`slot[name=${slotname}]`);\n            if (!node) {\n                node = this._createNode(slotname);\n            } else {\n                node = node.parentElement.parentElement;\n            }\n        }\n        const table = this.tables.get(viewer.getAttribute(\"table\") || config.table);\n        const widget = new PerspectiveViewerWidget({node, viewer});\n        const event = new CustomEvent(\"workspace-new-view\", {\n            detail: {config, widget}\n        });\n        this.element.dispatchEvent(event);\n        widget.title.closable = true;\n        this.element.appendChild(widget.viewer);\n        if (table) {\n            widget.viewer.load(table);\n        }\n        widget.restore(config).then(() => {\n            this._addWidgetEventListeners(widget);\n        });\n        return widget;\n    }\n\n    _addWidgetEventListeners(widget) {\n        if (this.listeners.has(widget)) {\n            this.listeners.get(widget)();\n        }\n        const settings = event => {\n            if (event.detail) {\n                widget.title.className += \" settings_open\";\n            } else {\n                widget.title.className = widget.title.className.replace(/settings_open/g, \"\");\n            }\n        };\n        const contextMenu = event => this.showContextMenu(widget, event);\n        const updated = event => {\n            this.workspaceUpdated();\n            if (this.mode === MODE.LINKED) {\n                const config = event.target?.save();\n                if (config) {\n                    const selectable = this._linkedViewers.length > 0 && !!config[\"row-pivots\"];\n                    if (selectable !== !!config.selectable) {\n                        event.target.restore({selectable});\n                    }\n                }\n            }\n        };\n        widget.node.addEventListener(\"contextmenu\", contextMenu);\n        widget.viewer.addEventListener(\"perspective-toggle-settings\", settings);\n        widget.viewer.addEventListener(\"perspective-config-update\", updated);\n        widget.viewer.addEventListener(\"perspective-plugin-update\", this.workspaceUpdated);\n        widget.title.changed.connect(updated);\n\n        this.listeners.set(widget, () => {\n            widget.node.removeEventListener(\"contextmenu\", contextMenu);\n            widget.viewer.removeEventListener(\"perspective-toggle-settings\", settings);\n            widget.viewer.removeEventListener(\"perspective-config-update\", updated);\n            widget.viewer.removeEventListener(\"perspective-plugin-update\", this.workspaceUpdated);\n            widget.title.changed.disconnect(updated);\n        });\n    }\n\n    getAllWidgets() {\n        return [...this.masterPanel.widgets, ...toArray(this.dockpanel.widgets())];\n    }\n\n    /***************************************************************************\n     *\n     * `workspace-layout-update` event\n     *\n     */\n\n    _fireUpdateEvent() {\n        const layout = this.save();\n        if (layout) {\n            const tables = {};\n            this.tables.forEach((value, key) => {\n                tables[key] = value;\n            });\n            this.element.dispatchEvent(new CustomEvent(\"workspace-layout-update\", {detail: {tables, layout}}));\n        }\n    }\n\n    workspaceUpdated = () => {\n        if (!this._save) {\n            this._save = debounce(() => this.dockpanel.mode !== \"single-document\" && this._fireUpdateEvent(), 500);\n        }\n        this._save();\n    };\n}\n"],"file":"workspace.js"}