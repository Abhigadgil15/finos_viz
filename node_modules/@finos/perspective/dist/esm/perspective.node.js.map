{"version":3,"sources":["../../src/js/perspective.node.js"],"names":["Client","require","Server","WebSocketManager","WebSocketClient","perspective","default","fs","http","WebSocket","process","path","load_perspective","LOCAL_PATH","join","cwd","buffer","readFileSync","resolve","SYNC_SERVER","init","msg","wasmBinary","wasmJSMethod","then","core","post","SYNC_CLIENT","_handle","data","send","id","cmd","module","exports","sync_module","DEFAULT_ASSETS","CONTENT_TYPES","read_promise","filePath","Promise","reject","readFile","error","content","code","perspective_assets","assets","host_psp","request","response","setHeader","url","split","extname","contentType","rootDir","console","log","writeHead","end","undefined","paths","map","x","e","indexOf","WebSocketServer","constructor","port","on_start","_server","createServer","_wss","noServer","perMessageDeflate","on","ws","add_connection","socket","head","handleUpgrade","sock","emit","listen","address","close","websocket","worker"],"mappings":"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","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nconst {Client} = require(\"./api/client.js\");\nconst {Server} = require(\"./api/server.js\");\nconst {WebSocketManager} = require(\"./websocket/manager\");\nconst {WebSocketClient} = require(\"./websocket/client\");\n\nconst perspective = require(\"./perspective.js\").default;\n\nconst fs = require(\"fs\");\nconst http = require(\"http\");\nconst WebSocket = require(\"ws\");\nconst process = require(\"process\");\nconst path = require(\"path\");\n\nconst load_perspective = require(\"./@finos/perspective-cpp/dist/cjs/perspective.cpp.js\").default;\n\n// eslint-disable-next-line no-undef\n\nconst LOCAL_PATH = path.join(process.cwd(), \"node_modules\");\nconst buffer = fs.readFileSync(require.resolve(\"./@finos/perspective-cpp/dist/cjs/perspective.cpp.wasm\")).buffer;\n\nconst SYNC_SERVER = new (class extends Server {\n    init(msg) {\n        load_perspective({\n            wasmBinary: buffer,\n            wasmJSMethod: \"native-wasm\"\n        }).then(core => {\n            this.perspective = perspective(core);\n            super.init(msg);\n        });\n    }\n\n    post(msg) {\n        SYNC_CLIENT._handle({data: msg});\n    }\n})();\n\nconst SYNC_CLIENT = new (class extends Client {\n    send(msg) {\n        SYNC_SERVER.process(msg);\n    }\n})();\n\nSYNC_CLIENT.send({id: -1, cmd: \"init\"});\n\nmodule.exports = SYNC_CLIENT;\nmodule.exports.sync_module = () => SYNC_SERVER.perspective;\n\nconst DEFAULT_ASSETS = [\n    \"@finos/perspective/dist/umd\",\n    \"@finos/perspective-bench/dist\",\n    \"@finos/perspective-viewer/dist/umd\",\n    \"@finos/perspective-viewer-datagrid/dist/umd\",\n    \"@finos/perspective-viewer-d3fc/dist/umd\",\n    \"@finos/perspective-workspace/dist/umd\"\n];\n\nconst CONTENT_TYPES = {\n    \".js\": \"text/javascript\",\n    \".css\": \"text/css\",\n    \".json\": \"application/json\",\n    \".arrow\": \"arraybuffer\",\n    \".wasm\": \"application/wasm\"\n};\n\nfunction read_promise(filePath) {\n    return new Promise((resolve, reject) => {\n        fs.readFile(filePath, function(error, content) {\n            if (error && error.code !== \"ENOENT\") {\n                reject(error);\n            } else {\n                resolve(content);\n            }\n        });\n    });\n}\n\n/**\n * Host a Perspective server that hosts data, code files, etc.\n */\nfunction perspective_assets(assets, host_psp) {\n    return async function(request, response) {\n        response.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n        response.setHeader(\"Access-Control-Request-Method\", \"*\");\n        response.setHeader(\"Access-Control-Allow-Methods\", \"OPTIONS,GET\");\n        response.setHeader(\"Access-Control-Allow-Headers\", \"*\");\n        let url = request.url.split(/[\\?\\#]/)[0];\n        if (url === \"/\") {\n            url = \"/index.html\";\n        }\n        let extname = path.extname(url);\n        let contentType = CONTENT_TYPES[extname] || \"text/html\";\n        try {\n            for (let rootDir of assets) {\n                let filePath = rootDir + url;\n                let content = await read_promise(filePath);\n                if (typeof content !== \"undefined\") {\n                    console.log(`200 ${url}`);\n                    response.writeHead(200, {\"Content-Type\": contentType});\n                    response.end(content, extname === \".arrow\" ? undefined : \"utf-8\");\n                    return;\n                }\n            }\n            if (host_psp || typeof host_psp === \"undefined\") {\n                for (let rootDir of DEFAULT_ASSETS) {\n                    try {\n                        let paths = require.resolve.paths(rootDir + url);\n                        paths = [...paths, ...assets.map(x => path.join(x, \"node_modules\")), LOCAL_PATH];\n                        let filePath = require.resolve(rootDir + url, {paths});\n                        let content = await read_promise(filePath);\n                        if (typeof content !== \"undefined\") {\n                            console.log(`200 ${url}`);\n                            response.writeHead(200, {\"Content-Type\": contentType});\n                            response.end(content, extname === \".arrow\" ? undefined : \"utf-8\");\n                            return;\n                        }\n                    } catch (e) {}\n                }\n            }\n            if (url.indexOf(\"favicon.ico\") > -1) {\n                response.writeHead(200);\n                response.end(\"\", \"utf-8\");\n            } else {\n                console.error(`404 ${url}`);\n                response.writeHead(404);\n                response.end(\"\", \"utf-8\");\n            }\n        } catch (error) {\n            if (error.code !== \"ENOENT\") {\n                console.error(`500 ${url}`);\n                response.writeHead(500);\n                response.end(\"\", \"utf-8\");\n            }\n        }\n    };\n}\n\nclass WebSocketServer extends WebSocketManager {\n    constructor({assets, host_psp, port, on_start} = {}) {\n        super();\n        port = typeof port === \"undefined\" ? 8080 : port;\n        assets = assets || [\"./\"];\n\n        // Serve Perspective files through HTTP\n        this._server = http.createServer(perspective_assets(assets, host_psp));\n\n        // Serve Worker API through WebSockets\n        this._wss = new WebSocket.Server({noServer: true, perMessageDeflate: true});\n\n        // When the server starts, define how to handle messages\n        this._wss.on(\"connection\", ws => this.add_connection(ws));\n\n        this._server.on(\"upgrade\", (request, socket, head) => {\n            console.log(\"200    *** websocket upgrade ***\");\n            this._wss.handleUpgrade(request, socket, head, sock => this._wss.emit(\"connection\", sock, request));\n        });\n\n        this._server.listen(port, () => {\n            console.log(`Listening on port ${this._server.address().port}`);\n            if (on_start) {\n                on_start();\n            }\n        });\n    }\n\n    close() {\n        this._server.close();\n    }\n}\n\n/**\n * Create a new Websocket connection to `url`, setting up the protocol for\n * a Perspective server and Perspective client to communicate.\n * @param {*} url\n */\nconst websocket = url => {\n    return new WebSocketClient(new WebSocket(url));\n};\n\nmodule.exports.worker = () => module.exports;\nmodule.exports.websocket = websocket;\nmodule.exports.perspective_assets = perspective_assets;\nmodule.exports.WebSocketServer = WebSocketServer;\nmodule.exports.WebSocketManager = WebSocketManager;\n"],"file":"perspective.node.js"}