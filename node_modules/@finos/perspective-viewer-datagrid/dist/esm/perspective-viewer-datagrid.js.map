{"version":3,"file":"perspective-viewer-datagrid.js","sources":["../../src/js/plugin_menu.js","../../src/js/color_utils.js","../../src/js/regular_table_handlers.js","../../src/js/getCellConfig.js","../../src/js/row_selection.js","../../src/js/click.js","../../src/js/editing.js","../../src/js/sorting.js","../../src/js/plugin.js"],"sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport chroma from \"chroma-js\";\n\nexport const PLUGIN_SYMBOL = Symbol(\"Plugin Symbol\");\n\nlet MENU = undefined;\n\nexport function activate_plugin_menu(regularTable, target, column_max) {\n    MENU = MENU || document.createElement(\"perspective-column-style\");\n    const target_meta = regularTable.getMeta(target);\n    const column_name = target_meta.column_header[target_meta.column_header.length - 1];\n    const column_type = this._schema[column_name];\n    const default_config = {\n        gradient: column_max,\n        pos_color: this._pos_color[0],\n        neg_color: this._neg_color[0]\n    };\n\n    if (column_type === \"float\") {\n        default_config.fixed = 2;\n    } else if (column_type === \"integer\") {\n        default_config.fixed = 0;\n    } else {\n        this._open_column_styles_menu.pop();\n        regularTable.draw();\n        return;\n    }\n\n    const scroll_handler = () => MENU.blur();\n    const update_handler = event => {\n        const config = event.detail;\n        if (config.pos_color) {\n            config.pos_color = [config.pos_color, ...chroma(config.pos_color).rgb()];\n            config.neg_color = [config.neg_color, ...chroma(config.neg_color).rgb()];\n        }\n\n        regularTable[PLUGIN_SYMBOL] = regularTable[PLUGIN_SYMBOL] || {};\n        regularTable[PLUGIN_SYMBOL][column_name] = config;\n        regularTable.draw({preserve_width: true});\n        regularTable.parentElement.dispatchEvent(new Event(\"perspective-config-update\"));\n    };\n\n    const blur_handler = async () => {\n        regularTable.removeEventListener(\"regular-table-scroll\", scroll_handler);\n        MENU.removeEventListener(\"perspective-column-style-change\", update_handler);\n        MENU.removeEventListener(\"blur\", blur_handler);\n        this._open_column_styles_menu.pop();\n        await regularTable.draw();\n        regularTable.parentElement.dispatchEvent(new Event(\"perspective-config-update\"));\n    };\n\n    MENU.addEventListener(\"perspective-column-style-change\", update_handler);\n    MENU.addEventListener(\"blur\", blur_handler);\n    regularTable.addEventListener(\"regular-table-scroll\", scroll_handler);\n\n    // Get the current column style config\n    const pset = regularTable[PLUGIN_SYMBOL] || {};\n    const config = Object.assign({}, (pset[column_name] = pset[column_name] || {}));\n    if (config.pos_color) {\n        config.pos_color = config.pos_color[0];\n        config.neg_color = config.neg_color[0];\n    }\n\n    // open the menu\n    MENU.open(target, config, default_config);\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nexport const PLUGIN_SYMBOL = Symbol(\"Plugin Symbol\");\n\n// AFAICT `chroma-js` has no alpha-aware blending? So we need a function to get\n// the color of a heatmap cell over the background.\nexport function rgbaToRgb([r, g, b, a], source = [255, 255, 255]) {\n    function f(i, c) {\n        return ((1 - a) * (source[i] / 255) + a * (c / 255)) * 255;\n    }\n\n    return [f(0, r), f(1, g), f(2, b)];\n}\n\n// Chroma does this but why bother?\nexport function infer_foreground_from_background([r, g, b]) {\n    // TODO Implement dark/light themes.\n    return Math.sqrt(r * r * 0.299 + g * g * 0.587 + b * b * 0.114) > 130 ? \"#161616\" : \"#ffffff\";\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport {get_type_config} from \"@finos/perspective/dist/esm/config/index.js\";\nimport {activate_plugin_menu, PLUGIN_SYMBOL} from \"./plugin_menu.js\";\nimport {rgbaToRgb, infer_foreground_from_background} from \"./color_utils.js\";\n\nimport chroma from \"chroma-js\";\n\nfunction styleListener(regularTable) {\n    const header_depth = regularTable._view_cache.config.row_pivots.length - 1;\n    let group_headers = Array.from(regularTable.children[0].children[0].children);\n    let [col_headers] = group_headers.splice(group_headers.length - 1, 1);\n    const plugins = regularTable[PLUGIN_SYMBOL] || {};\n\n    for (const td of col_headers?.children) {\n        const metadata = regularTable.getMeta(td);\n        const column_name = metadata.column_header?.[metadata.column_header?.length - 1];\n        const sort = this._config.sort.find(x => x[0] === column_name);\n        let needs_border = metadata.row_header_x === header_depth;\n        const is_corner = typeof metadata.x === \"undefined\";\n        needs_border = needs_border || (metadata.x + 1) % this._config.columns.length === 0;\n        td.classList.toggle(\"psp-header-border\", needs_border);\n        td.classList.toggle(\"psp-header-group\", false);\n        td.classList.toggle(\"psp-header-leaf\", true);\n        td.classList.toggle(\"psp-is-top\", false);\n        td.classList.toggle(\"psp-header-corner\", is_corner);\n        td.classList.toggle(\"psp-header-sort-asc\", !!sort && sort[1] === \"asc\");\n        td.classList.toggle(\"psp-header-sort-desc\", !!sort && sort[1] === \"desc\");\n        td.classList.toggle(\"psp-header-sort-col-asc\", !!sort && sort[1] === \"col asc\");\n        td.classList.toggle(\"psp-header-sort-col-desc\", !!sort && sort[1] === \"col desc\");\n\n        let type = get_psp_type.call(this, metadata);\n        const is_numeric = type === \"integer\" || type === \"float\";\n        const float_val = is_numeric && metadata.user;\n        td.classList.toggle(\"psp-align-right\", is_numeric);\n        td.classList.toggle(\"psp-align-left\", !is_numeric);\n        td.classList.toggle(\"psp-positive\", float_val > 0);\n        td.classList.toggle(\"psp-negative\", float_val < 0);\n        td.classList.toggle(\"psp-menu-open\", this._open_column_styles_menu[0] === metadata._virtual_x);\n        td.classList.toggle(\"psp-menu-enabled\", is_numeric && !is_corner);\n\n        // Color plugin\n        // const plugin = plugins[column_name];\n        // if (plugin?.pos_color !== undefined) {\n        //     const [, r, g, b] = plugin.pos_color;\n        //     const foreground = infer_foreground_from_background([r, g, b]);\n        //     td.style.backgroundColor = plugin.pos_color[0];\n        //     td.style.color = foreground;\n        // } else {\n        //     td.style.backgroundColor = \"\";\n        //     td.style.color = \"\";\n        // }\n    }\n\n    const m = [];\n    let marked = new Set();\n    const table = regularTable.children[0];\n    for (let y = 0; y < group_headers.length; y++) {\n        let row = table.rows[y];\n        const tops = new Set();\n        for (let x = 0; x < row.cells.length; x++) {\n            const td = row.cells[x];\n            td.style.backgroundColor = \"\";\n            const metadata = regularTable.getMeta(td);\n            let needs_border = metadata.row_header_x === header_depth || metadata.x >= 0;\n            td.classList.toggle(\"psp-align-right\", false);\n            td.classList.toggle(\"psp-align-left\", false);\n            td.classList.toggle(\"psp-header-group\", true);\n            td.classList.toggle(\"psp-header-leaf\", false);\n            td.classList.toggle(\"psp-header-border\", needs_border);\n            td.classList.toggle(\"psp-header-group-corner\", typeof metadata.x === \"undefined\");\n            let cell = row.cells[x],\n                xx = x,\n                tx,\n                ty;\n\n            for (; m[y] && m[y][xx]; ++xx);\n            tops.add(xx);\n            for (tx = xx; tx < xx + cell.colSpan; ++tx) {\n                for (ty = y; ty < y + cell.rowSpan; ++ty) {\n                    if (!m[ty]) m[ty] = [];\n                    m[ty][tx] = true;\n                }\n            }\n\n            cell.classList.toggle(\"psp-is-top\", y === 0 || !marked.has(tx));\n        }\n        marked = tops;\n    }\n\n    // this._cached_range = this._cached_range || {};\n    for (const tr of regularTable.children[0].children[1].children) {\n        for (const td of tr.children) {\n            const metadata = regularTable.getMeta(td);\n            const column_name = metadata.column_header?.[metadata.column_header?.length - 1];\n            const plugin = plugins[column_name];\n\n            let type = get_psp_type.call(this, metadata);\n            const is_numeric = type === \"integer\" || type === \"float\";\n\n            if (is_numeric) {\n                const is_positive = metadata.user > 0;\n                const is_negative = metadata.user < 0;\n                const [hex, r, g, b] = (() => {\n                    if (plugin?.pos_color !== undefined) {\n                        return is_positive ? plugin.pos_color : is_negative ? plugin.neg_color : [\"\", 0, 0, 0];\n                    } else {\n                        return is_positive ? this._pos_color : is_negative ? this._neg_color : [\"\", 0, 0, 0];\n                    }\n                })();\n\n                if (plugin?.color_mode === \"background\") {\n                    const source = this._plugin_background;\n                    const foreground = infer_foreground_from_background(rgbaToRgb([r, g, b, 1], source));\n                    td.style.color = foreground;\n                    td.style.backgroundColor = hex;\n                } else if (plugin?.color_mode === \"gradient\") {\n                    const a = Math.max(0, Math.min(1, Math.abs(metadata.user / plugin.gradient)));\n                    const source = this._plugin_background;\n                    const foreground = infer_foreground_from_background(rgbaToRgb([r, g, b, a], source));\n                    td.style.color = foreground;\n                    td.style.backgroundColor = `rgba(${r},${g},${b},${a})`;\n                } else if (plugin?.color_mode === \"foreground\") {\n                    td.style.backgroundColor = \"\";\n                    td.style.color = hex;\n                } else {\n                    td.style.backgroundColor = \"\";\n                    td.style.color = \"\";\n                }\n            } else {\n                td.style.backgroundColor = \"\";\n                td.style.color = \"\";\n            }\n\n            const is_th = td.tagName === \"TH\";\n            if (is_th) {\n                const is_not_empty = !!metadata.value && metadata.value.toString().trim().length > 0;\n                const is_leaf = metadata.row_header_x >= this._config.row_pivots.length;\n                const next = regularTable.getMeta({dx: 0, dy: metadata.y - metadata.y0 + 1});\n                const is_collapse = next && next.row_header && typeof next.row_header[metadata.row_header_x + 1] !== \"undefined\";\n                td.classList.toggle(\"psp-tree-label\", is_not_empty && !is_leaf);\n                td.classList.toggle(\"psp-tree-label-expand\", is_not_empty && !is_leaf && !is_collapse);\n                td.classList.toggle(\"psp-tree-label-collapse\", is_not_empty && !is_leaf && is_collapse);\n                td.classList.toggle(\"psp-tree-leaf\", is_not_empty && is_leaf);\n            }\n\n            const float_val = is_numeric && metadata.user;\n            td.classList.toggle(\"psp-align-right\", !is_th && is_numeric);\n            td.classList.toggle(\"psp-align-left\", is_th || !is_numeric);\n            td.classList.toggle(\"psp-positive\", float_val > 0);\n            td.classList.toggle(\"psp-negative\", float_val < 0);\n        }\n    }\n}\n\nfunction get_psp_type(metadata) {\n    if (metadata.x >= 0) {\n        const column_path = this._column_paths[metadata.x];\n        const column_path_parts = column_path.split(\"|\");\n        return this._schema[column_path_parts[column_path_parts.length - 1]];\n    } else {\n        const column_path = this._config.row_pivots[metadata.row_header_x - 1];\n        return this._table_schema[column_path];\n    }\n}\n\nasync function sortHandler(regularTable, event, target) {\n    const meta = regularTable.getMeta(target);\n    const column_name = meta.column_header[meta.column_header.length - 1];\n    const sort_method = event.shiftKey ? append_sort : override_sort;\n    const sort = sort_method.call(this, column_name);\n    regularTable.dispatchEvent(new CustomEvent(\"regular-table-psp-sort\", {detail: {sort}}));\n}\n\nfunction append_sort(column_name) {\n    const sort = [];\n    let found = false;\n    for (const sort_term of this._config.sort) {\n        const [_column_name, _sort_dir] = sort_term;\n        if (_column_name === column_name) {\n            found = true;\n            const term = create_sort.call(this, column_name, _sort_dir);\n            if (term) {\n                sort.push(term);\n            }\n        } else {\n            sort.push(sort_term);\n        }\n    }\n    if (!found) {\n        sort.push([column_name, \"desc\"]);\n    }\n    return sort;\n}\nfunction override_sort(column_name) {\n    for (const [_column_name, _sort_dir] of this._config.sort) {\n        if (_column_name === column_name) {\n            const sort = create_sort.call(this, column_name, _sort_dir);\n            return sort ? [sort] : [];\n        }\n    }\n    return [[column_name, \"desc\"]];\n}\nfunction create_sort(column_name, sort_dir) {\n    const is_col_sortable = this._config.column_pivots.length > 0;\n    const order = is_col_sortable ? ROW_COL_SORT_ORDER : ROW_SORT_ORDER;\n    const inc_sort_dir = sort_dir ? order[sort_dir] : \"desc\";\n    if (inc_sort_dir) {\n        return [column_name, inc_sort_dir];\n    }\n}\n\nconst ROW_SORT_ORDER = {desc: \"asc\", asc: undefined};\nconst ROW_COL_SORT_ORDER = {desc: \"asc\", asc: \"col desc\", \"col desc\": \"col asc\", \"col asc\": undefined};\n\nasync function expandCollapseHandler(regularTable, event) {\n    const meta = regularTable.getMeta(event.target);\n    const is_collapse = event.target.classList.contains(\"psp-tree-label-collapse\");\n    if (event.shiftKey && is_collapse) {\n        this._view.set_depth(meta.row_header.filter(x => x !== undefined).length - 2);\n    } else if (event.shiftKey) {\n        this._view.set_depth(meta.row_header.filter(x => x !== undefined).length - 1);\n    } else if (is_collapse) {\n        this._view.collapse(meta.y);\n    } else {\n        this._view.expand(meta.y);\n    }\n    this._num_rows = await this._view.num_rows();\n    this._num_columns = await this._view.num_columns();\n    regularTable.draw();\n}\n\nasync function mousedownListener(regularTable, event) {\n    if (event.which !== 1) {\n        return;\n    }\n\n    let target = event.target;\n    while (target.tagName !== \"TD\" && target.tagName !== \"TH\") {\n        target = target.parentElement;\n        if (!regularTable.contains(target)) {\n            return;\n        }\n    }\n\n    if (target.classList.contains(\"psp-tree-label\") && event.offsetX < 26) {\n        expandCollapseHandler.call(this, regularTable, event);\n        event.stopImmediatePropagation();\n        return;\n    }\n\n    const rect = target.getBoundingClientRect();\n    if (target.classList.contains(\"psp-menu-enabled\") && event.clientY - rect.top > 16) {\n        const meta = regularTable.getMeta(target);\n        const column_name = meta.column_header?.[meta.column_header?.length - 1];\n        const [, max] = await this._view.get_min_max(column_name);\n        this._open_column_styles_menu.unshift(meta._virtual_x);\n        regularTable.draw();\n        activate_plugin_menu.call(this, regularTable, target, max);\n        event.preventDefault();\n        event.stopImmediatePropagation();\n    } else if (target.classList.contains(\"psp-header-leaf\") && !target.classList.contains(\"psp-header-corner\")) {\n        sortHandler.call(this, regularTable, event, target);\n        event.stopImmediatePropagation();\n    }\n}\n\nfunction clickListener(regularTable, event) {\n    if (event.which !== 1) {\n        return;\n    }\n\n    let target = event.target;\n    while (target.tagName !== \"TD\" && target.tagName !== \"TH\") {\n        target = target.parentElement;\n        if (!regularTable.contains(target)) {\n            return;\n        }\n    }\n\n    if (target.classList.contains(\"psp-tree-label\") && event.offsetX < 26) {\n        event.stopImmediatePropagation();\n    } else if (target.classList.contains(\"psp-header-leaf\") && !target.classList.contains(\"psp-header-corner\")) {\n        event.stopImmediatePropagation();\n    }\n}\n\nconst FORMATTERS = {};\n\nconst FORMATTER_CONS = {\n    datetime: Intl.DateTimeFormat,\n    date: Intl.DateTimeFormat,\n    integer: Intl.NumberFormat,\n    float: Intl.NumberFormat\n};\n\nexport const formatters = FORMATTERS;\n\nfunction _format(parts, val, plugins = {}, use_table_schema = false) {\n    if (val === null) {\n        return \"-\";\n    }\n\n    const title = parts[parts.length - 1];\n    const plugin = plugins[title];\n    const type = (use_table_schema && this._table_schema[title]) || this._schema[title] || \"string\";\n    const is_numeric = type === \"integer\" || type === \"float\";\n    const is_plugin_override = is_numeric && plugin && plugin.fixed !== undefined;\n    let formatter_key = is_plugin_override ? `${type}${plugin.fixed}` : type;\n    if (FORMATTERS[formatter_key] === undefined) {\n        const type_config = get_type_config(type);\n        if (is_plugin_override) {\n            const opts = {minimumFractionDigits: plugin.fixed, maximumFractionDigits: plugin.fixed};\n            FORMATTERS[formatter_key] = new FORMATTER_CONS[type](\"en-us\", opts);\n        } else if (FORMATTER_CONS[type] && type_config.format) {\n            FORMATTERS[formatter_key] = new FORMATTER_CONS[type](\"en-us\", type_config.format);\n        } else {\n            FORMATTERS[formatter_key] = false;\n        }\n    }\n\n    return FORMATTERS[formatter_key] ? FORMATTERS[formatter_key].format(val) : val;\n}\n\nfunction* _tree_header(paths = [], row_headers, regularTable) {\n    const plugins = regularTable[PLUGIN_SYMBOL];\n    for (let path of paths) {\n        path = [\"TOTAL\", ...path];\n        const last = path[path.length - 1];\n        path = path.slice(0, path.length - 1).fill(\"\");\n        const formatted = _format.call(this, [row_headers[path.length - 1]], last, plugins, true);\n        path = path.concat({toString: () => formatted});\n        path.length = row_headers.length + 1;\n        yield path;\n    }\n}\n\nasync function dataListener(regularTable, x0, y0, x1, y1) {\n    let columns = {};\n    if (x1 - x0 > 0 && y1 - y0 > 0) {\n        columns = await this._view.to_columns({\n            start_row: y0,\n            start_col: x0,\n            end_row: y1,\n            end_col: x1,\n            id: true\n        });\n        this._ids = columns.__ID__;\n    }\n    const data = [],\n        metadata = [];\n    const column_headers = [];\n    for (const path of this._column_paths.slice(x0, x1)) {\n        const path_parts = path.split(\"|\");\n        const column = columns[path] || new Array(y1 - y0).fill(null);\n        data.push(column.map(x => _format.call(this, path_parts, x, regularTable[PLUGIN_SYMBOL])));\n        metadata.push(column);\n        column_headers.push(path_parts);\n    }\n\n    return {\n        num_rows: this._num_rows,\n        num_columns: this._column_paths.length,\n        row_headers: Array.from(_tree_header.call(this, columns.__ROW_PATH__, this._config.row_pivots, regularTable)),\n        column_headers,\n        data,\n        metadata\n    };\n}\n\nfunction get_rule(regular, tag, def) {\n    let color = window\n        .getComputedStyle(regular)\n        .getPropertyValue(tag)\n        .trim();\n    if (color.length > 0) {\n        return color;\n    } else {\n        return def;\n    }\n}\n\nexport async function createModel(regular, table, view, extend = {}) {\n    const config = await view.get_config();\n\n    // Extract the entire expression string as typed by the user, so we can\n    // feed it into `validate_expressions` and get back the data types for\n    // each column without it being affected by a pivot.\n    const expressions = config.expressions.map(expr => expr[1]);\n\n    const [table_schema, validated_expressions, num_rows, schema, expression_schema, column_paths] = await Promise.all([\n        table.schema(),\n        table.validate_expressions(expressions),\n        view.num_rows(),\n        view.schema(),\n        view.expression_schema(),\n        view.column_paths()\n    ]);\n\n    const _plugin_background = chroma(get_rule(regular, \"--plugin--background\", \"#FFFFFF\")).rgb();\n    let _pos_color = get_rule(regular, \"--rt-pos-cell--color\", \"#0000ff\");\n    _pos_color = [_pos_color, ...chroma(_pos_color).rgb()];\n    let _neg_color = get_rule(regular, \"--rt-neg-cell--color\", \"#ff0000\");\n    _neg_color = [_neg_color, ...chroma(_neg_color).rgb()];\n    const model = Object.assign(extend, {\n        _view: view,\n        _table: table,\n        _table_schema: {...table_schema, ...validated_expressions.expression_schema},\n        _config: config,\n        _num_rows: num_rows,\n        _schema: {...schema, ...expression_schema},\n        _ids: [],\n        _open_column_styles_menu: [],\n        _plugin_background,\n        _pos_color,\n        _neg_color,\n        _column_paths: column_paths.filter(path => {\n            return path !== \"__ROW_PATH__\" && path !== \"__ID__\";\n        })\n    });\n    regular.setDataListener(dataListener.bind(model, regular));\n    return model;\n}\n\nexport async function configureRegularTable(regular, model) {\n    regular.addStyleListener(styleListener.bind(model, regular));\n    regular.addEventListener(\"mousedown\", mousedownListener.bind(model, regular));\n    regular.addEventListener(\"click\", clickListener.bind(model, regular));\n    await regular.draw();\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nexport default async function getCellConfig({_view, _config}, row_idx, col_idx) {\n    const row_pivots = _config.row_pivots;\n    const column_pivots = _config.column_pivots;\n    const start_row = row_idx >= 0 ? row_idx : 0;\n    const end_row = start_row + 1;\n    const r = await _view.to_json({start_row, end_row});\n    const row_paths = r.map(x => x.__ROW_PATH__);\n    const row_pivots_values = row_paths[0] || [];\n    const row_filters = row_pivots\n        .map((pivot, index) => {\n            const pivot_value = row_pivots_values[index];\n            return pivot_value ? [pivot, \"==\", pivot_value] : undefined;\n        })\n        .filter(x => x);\n\n    const column_index = row_pivots.length > 0 ? col_idx + 1 : col_idx;\n    const column_paths = Object.keys(r[0])[column_index];\n    const result = {row: r[0]};\n    let column_filters = [];\n    if (column_paths) {\n        const column_pivot_values = column_paths.split(\"|\");\n        result.column_names = [column_pivot_values[column_pivot_values.length - 1]];\n        column_filters = column_pivots\n            .map((pivot, index) => {\n                const pivot_value = column_pivot_values[index];\n                return pivot_value ? [pivot, \"==\", pivot_value] : undefined;\n            })\n            .filter(x => x)\n            .filter(([, , value]) => value !== \"__ROW_PATH__\");\n    }\n\n    const filters = _config.filter.concat(row_filters).concat(column_filters);\n    result.config = {filters};\n    return result;\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport getCellConfig from \"./getCellConfig\";\nconst selected_rows_map = new WeakMap();\n\nasync function selectionListener(regularTable, viewer, event) {\n    const meta = regularTable.getMeta(event.target);\n    if (!viewer.hasAttribute(\"selectable\")) return;\n    if (event.handled) return;\n    if (event.which !== 1) {\n        return;\n    }\n\n    if (!meta) {\n        return;\n    }\n\n    const id = this._ids[meta.y - meta.y0];\n    if (meta && meta.y >= 0) {\n        const selected = selected_rows_map.get(regularTable);\n        const key_match = !!selected && selected.reduce((agg, x, i) => agg && x === id[i], true);\n        const is_deselect = !!selected && id.length === selected.length && key_match;\n        let filters = [];\n        if (is_deselect) {\n            selected_rows_map.delete(regularTable);\n        } else {\n            selected_rows_map.set(regularTable, id);\n            filters = await getCellConfig(this, meta.y, meta.x);\n            filters = filters.config.filters;\n        }\n\n        await regularTable.draw();\n        event.handled = true;\n        viewer.dispatchEvent(\n            new CustomEvent(\"perspective-select\", {\n                bubbles: true,\n                composed: true,\n                detail: {\n                    selected: !is_deselect,\n                    config: {filters}\n                }\n            })\n        );\n    }\n}\n\nfunction selectionStyleListener(regularTable, viewer) {\n    if (!viewer.hasAttribute(\"selectable\")) return;\n    const has_selected = selected_rows_map.has(regularTable);\n    const selected = selected_rows_map.get(regularTable);\n    for (const td of regularTable.querySelectorAll(\"td\")) {\n        if (!has_selected) {\n            td.classList.toggle(\"psp-row-selected\", false);\n            td.classList.toggle(\"psp-row-subselected\", false);\n        } else {\n            const meta = regularTable.getMeta(td);\n            const id = this._ids[meta.y - meta.y0];\n            const key_match = selected.reduce((agg, x, i) => agg && x === id[i], true);\n            td.classList.toggle(\"psp-row-selected\", id.length === selected.length && key_match);\n            td.classList.toggle(\"psp-row-subselected\", id.length !== selected.length && key_match);\n        }\n    }\n\n    for (const th of regularTable.querySelectorAll(\"tbody th\")) {\n        const meta = regularTable.getMeta(th);\n        const id = this._ids[meta.y - meta.y0];\n        if (!has_selected || !!id[meta.row_header_x]) {\n            th.classList.toggle(\"psp-row-selected\", false);\n            th.classList.toggle(\"psp-row-subselected\", false);\n        } else {\n            const key_match = selected.reduce((agg, x, i) => agg && x === id[i], true);\n            th.classList.toggle(\"psp-row-selected\", id.length === selected.length && key_match);\n            th.classList.toggle(\"psp-row-subselected\", id.length !== selected.length && key_match);\n        }\n    }\n}\n\nexport function configureRowSelectable(table, viewer) {\n    table.addStyleListener(selectionStyleListener.bind(this, table, viewer));\n    table.addEventListener(\"mousedown\", selectionListener.bind(this, table, viewer));\n}\n\nexport async function deselect(regularTable) {\n    selected_rows_map.delete(regularTable);\n    for (const td of regularTable.querySelectorAll(\"td,th\")) {\n        td.classList.toggle(\"psp-row-selected\", false);\n        td.classList.toggle(\"psp-row-subselected\", false);\n    }\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport getCellConfig from \"./getCellConfig\";\n\nasync function clickListener(table, viewer, event) {\n    const meta = table.getMeta(event.target);\n    if (!meta) return;\n    const {x, y} = meta;\n\n    const {row, column_names, config} = await getCellConfig(this, y, x);\n\n    viewer.dispatchEvent(\n        new CustomEvent(\"perspective-click\", {\n            bubbles: true,\n            composed: true,\n            detail: {\n                row,\n                column_names,\n                config\n            }\n        })\n    );\n}\n\nexport function configureClick(table, viewer) {\n    table.addEventListener(\"click\", clickListener.bind(this, table, viewer));\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nconst selected_position_map = new WeakMap();\n\nfunction lock(body) {\n    let lock;\n    return async function(...args) {\n        if (!!lock && (await lock) && !!lock) {\n            return;\n        }\n\n        let resolve;\n        lock = new Promise(x => (resolve = x));\n        await body.apply(this, args);\n        lock = undefined;\n        resolve();\n    };\n}\n\nfunction getPos() {\n    if (this.isContentEditable) {\n        let _range = document.getSelection().getRangeAt(0);\n        let range = _range.cloneRange();\n        range.selectNodeContents(this);\n        range.setEnd(_range.endContainer, _range.endOffset);\n        return range.toString().length;\n    } else {\n        return this.target.selectionStart;\n    }\n}\n\nfunction write(table, model, active_cell) {\n    const meta = table.getMeta(active_cell);\n    const type = model._schema[model._column_paths[meta.x]];\n    if (meta) {\n        let text = active_cell.textContent;\n        const id = model._ids[meta.y - meta.y0];\n        if (type === \"float\" || type === \"integer\") {\n            text = parseFloat(text.replace(/,/g, \"\"));\n            if (isNaN(text)) {\n                return false;\n            }\n        } else if (type === \"date\" || type === \"datetime\") {\n            text = Date.parse(text);\n            if (isNaN(text)) {\n                return false;\n            }\n        }\n\n        const msg = {\n            __INDEX__: id,\n            [model._column_paths[meta.x]]: text\n        };\n\n        model._table.update([msg], {port_id: model._edit_port});\n        return true;\n    }\n}\n\nfunction isEditable(viewer) {\n    const has_pivots = this._config.row_pivots.length === 0 && this._config.column_pivots.length === 0;\n    const selectable = viewer.hasAttribute(\"selectable\");\n    const editable = viewer.hasAttribute(\"editable\");\n    return has_pivots && !selectable && editable;\n}\n\nconst moveSelection = lock(async function(table, active_cell, dx, dy) {\n    const meta = table.getMeta(active_cell);\n    const num_columns = this._column_paths.length;\n    const num_rows = this._num_rows;\n    const selected_position = selected_position_map.get(table);\n    if (!selected_position) {\n        return;\n    }\n\n    if (meta.x + dx < num_columns && 0 <= meta.x + dx) {\n        selected_position.x = meta.x + dx;\n    }\n\n    if (meta.y + dy < num_rows && 0 <= meta.y + dy) {\n        selected_position.y = meta.y + dy;\n    }\n\n    const xmin = Math.max(meta.x0 - 10, 0);\n    const xmax = Math.min(meta.x0 + 10, num_columns);\n    const ymin = Math.max(meta.y0 - 5, 0);\n    const ymax = Math.min(meta.y0 + 10, num_rows);\n    let x = meta.x0 + dx,\n        y = meta.y0 + dy;\n    while (!focusStyleListener(table) && x >= xmin && x < xmax && y >= ymin && y < ymax) {\n        await table.scrollToCell(x, y, num_columns, num_rows);\n        selected_position_map.set(table, selected_position);\n        x += dx;\n        y += dy;\n    }\n});\n\n// Styles\n\nfunction editableStyleListener(table, viewer) {\n    // Independently check \"editable\" and `isEditable()`, so we can skip\n    // the styler entirely if editing was disabled at the time of element\n    // creation, but toggle in when e.g. pivots or selectable will\n    // affect editability.\n    if (!viewer.hasAttribute(\"editable\")) {\n        return;\n    }\n    const edit = isEditable.call(this, viewer);\n    for (const td of table.querySelectorAll(\"td\")) {\n        td.toggleAttribute(\"contenteditable\", edit);\n    }\n}\n\nconst focusStyleListener = table => {\n    const tds = table.querySelectorAll(\"td\");\n    const selected_position = selected_position_map.get(table);\n    if (selected_position) {\n        for (const td of tds) {\n            const meta = table.getMeta(td);\n            if (meta.x === selected_position.x && meta.y === selected_position.y) {\n                if (document.activeElement !== td) {\n                    td.focus({preventScroll: true});\n                }\n                return true;\n            }\n        }\n        if (document.activeElement !== document.body && table.contains(document.activeElement)) {\n            document.activeElement.blur();\n        }\n    }\n};\n\n// Events\n\nfunction keydownListener(table, viewer, event) {\n    if (!isEditable.call(this, viewer)) {\n        return;\n    }\n    const target = document.activeElement;\n    event.target.classList.remove(\"psp-error\");\n    switch (event.keyCode) {\n        case 13:\n            event.preventDefault();\n            if (event.shiftKey) {\n                moveSelection.call(this, table, target, 0, -1);\n            } else {\n                moveSelection.call(this, table, target, 0, 1);\n            }\n            break;\n        case 37:\n            if (getPos.call(target) == 0) {\n                event.preventDefault();\n                moveSelection.call(this, table, target, -1, 0);\n            }\n            break;\n        case 38:\n            event.preventDefault();\n            moveSelection.call(this, table, target, 0, -1);\n            break;\n        case 39:\n            if (getPos.call(target) == target.textContent.length) {\n                event.preventDefault();\n                moveSelection.call(this, table, target, 1, 0);\n            }\n            break;\n        case 40:\n            event.preventDefault();\n            moveSelection.call(this, table, target, 0, 1);\n            break;\n        default:\n    }\n}\n\nfunction focusoutListener(table, viewer, event) {\n    if (isEditable.call(this, viewer) && selected_position_map.has(table)) {\n        event.target.classList.remove(\"psp-error\");\n        const selectedPosition = selected_position_map.get(table);\n        selected_position_map.delete(table);\n        if (selectedPosition.content !== event.target.textContent) {\n            if (!write(table, this, event.target)) {\n                event.target.textContent = selectedPosition.content;\n                event.target.classList.add(\"psp-error\");\n                event.target.focus();\n            }\n        }\n    }\n}\n\nfunction focusinListener(table, viewer, event) {\n    const meta = table.getMeta(event.target);\n    if (meta) {\n        const new_state = {x: meta.x, y: meta.y, content: event.target.textContent};\n        selected_position_map.set(table, new_state);\n    }\n}\n\n// Plugin\n\nexport async function configureEditable(table, viewer) {\n    this._edit_port = await viewer.getEditPort();\n    table.addStyleListener(editableStyleListener.bind(this, table, viewer));\n    table.addStyleListener(focusStyleListener.bind(this, table, viewer));\n    table.addEventListener(\"focusin\", focusinListener.bind(this, table, viewer));\n    table.addEventListener(\"focusout\", focusoutListener.bind(this, table, viewer));\n    table.addEventListener(\"keydown\", keydownListener.bind(this, table, viewer));\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nexport async function configureSortable(table, viewer) {\n    table.addEventListener(\"regular-table-psp-sort\", event => {\n        this._preserve_focus_state = true;\n        viewer.setAttribute(\"sort\", JSON.stringify(event.detail.sort));\n    });\n}\n","/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport {registerPlugin} from \"@finos/perspective-viewer/src/js/utils.js\";\n\nimport \"regular-table\";\nimport {createModel, configureRegularTable, formatters} from \"./regular_table_handlers.js\";\nimport MATERIAL_STYLE from \"../less/regular_table.less\";\n\nimport {configureRowSelectable, deselect} from \"./row_selection.js\";\nimport {configureClick} from \"./click.js\";\nimport {configureEditable} from \"./editing.js\";\nimport {configureSortable} from \"./sorting.js\";\nimport {PLUGIN_SYMBOL} from \"./plugin_menu.js\";\n\nconst VIEWER_MAP = new WeakMap();\nconst INSTALLED = new WeakMap();\n\nfunction lock(body) {\n    let lock;\n    return async function(...args) {\n        while (lock) {\n            await lock;\n        }\n\n        let resolve;\n        try {\n            lock = new Promise(x => (resolve = x));\n            await body.apply(this, args);\n        } finally {\n            lock = undefined;\n            resolve();\n        }\n    };\n}\n\nconst datagridPlugin = lock(async function(regular, viewer, view) {\n    const is_installed = INSTALLED.has(regular);\n    const table = viewer.table;\n    let model;\n    if (!is_installed) {\n        model = await createModel(regular, table, view);\n        configureRegularTable(regular, model);\n        await configureSortable.call(model, regular, viewer);\n        await configureRowSelectable.call(model, regular, viewer);\n        await configureEditable.call(model, regular, viewer);\n        await configureClick.call(model, regular, viewer);\n        INSTALLED.set(regular, model);\n    } else {\n        model = INSTALLED.get(regular);\n        await createModel(regular, table, view, model);\n    }\n\n    const draw = regular.draw({invalid_columns: true});\n    if (!model._preserve_focus_state) {\n        regular.scrollTop = 0;\n        regular.scrollLeft = 0;\n        deselect(regular, viewer);\n        regular._resetAutoSize();\n    } else {\n        model._preserve_focus_state = false;\n    }\n\n    await draw;\n});\n\n/**\n * Initializes a new datagrid renderer if needed, or returns an existing one\n * associated with a rendering `<div>` from a cache.\n *\n * @param {*} element\n * @param {*} div\n * @returns\n */\nfunction get_or_create_datagrid(element, div) {\n    let datagrid;\n    if (!VIEWER_MAP.has(div)) {\n        datagrid = document.createElement(\"regular-table\");\n        datagrid.formatters = formatters;\n        div.innerHTML = \"\";\n        div.appendChild(document.createElement(\"slot\"));\n        element.appendChild(datagrid);\n        VIEWER_MAP.set(div, datagrid);\n    } else {\n        datagrid = VIEWER_MAP.get(div);\n        if (!datagrid.isConnected) {\n            div.innerHTML = \"\";\n            div.appendChild(document.createElement(\"slot\"));\n            datagrid.clear();\n            element.appendChild(datagrid);\n        }\n    }\n\n    return datagrid;\n}\n\n/**\n * <perspective-viewer> plugin.\n *\n * @class DatagridPlugin\n */\nclass DatagridPlugin {\n    static name = \"Datagrid\";\n    static selectMode = \"toggle\";\n    static deselectMode = \"pivots\";\n\n    static async update(div) {\n        const datagrid = VIEWER_MAP.get(div);\n        const model = INSTALLED.get(datagrid);\n        model._num_rows = await model._view.num_rows();\n        await datagrid.draw();\n    }\n\n    static async create(div, view) {\n        const datagrid = get_or_create_datagrid(this, div);\n        await datagridPlugin(datagrid, this, view);\n    }\n\n    static async resize() {\n        if (this.view && VIEWER_MAP.has(this._datavis)) {\n            const datagrid = VIEWER_MAP.get(this._datavis);\n            if (INSTALLED.has(datagrid)) {\n                await datagrid.draw();\n            }\n        }\n    }\n\n    static delete() {\n        if (this.view && VIEWER_MAP.has(this._datavis)) {\n            const datagrid = VIEWER_MAP.get(this._datavis);\n            datagrid.clear();\n        }\n    }\n\n    static save() {\n        if (VIEWER_MAP.has(this._datavis)) {\n            const datagrid = VIEWER_MAP.get(this._datavis);\n            if (datagrid[PLUGIN_SYMBOL]) {\n                return JSON.parse(JSON.stringify(datagrid[PLUGIN_SYMBOL]));\n            }\n        }\n    }\n\n    static restore(token) {\n        const datagrid = get_or_create_datagrid(this, this._datavis);\n        datagrid[PLUGIN_SYMBOL] = token;\n    }\n}\n\n/**\n * Appends the default table CSS to `<head>`, should be run once on module\n * import.\n *\n */\nfunction _register_global_styles() {\n    const style = document.createElement(\"style\");\n    style.textContent = MATERIAL_STYLE;\n    document.head.appendChild(style);\n}\n\n/******************************************************************************\n *\n * Main\n *\n */\n\nregisterPlugin(\"datagrid\", DatagridPlugin);\n\n_register_global_styles();\n"],"names":["PLUGIN_SYMBOL","Symbol","MENU","undefined","activate_plugin_menu","regularTable","target","column_max","document","createElement","target_meta","getMeta","column_name","column_header","length","column_type","_schema","default_config","gradient","pos_color","_pos_color","neg_color","_neg_color","fixed","_open_column_styles_menu","pop","draw","scroll_handler","blur","update_handler","event","config","detail","chroma","rgb","preserve_width","parentElement","dispatchEvent","Event","blur_handler","removeEventListener","addEventListener","pset","Object","assign","open","rgbaToRgb","r","g","b","a","source","f","i","c","infer_foreground_from_background","Math","sqrt","styleListener","header_depth","_view_cache","row_pivots","group_headers","Array","from","children","col_headers","splice","plugins","td","metadata","sort","_config","find","x","needs_border","row_header_x","is_corner","columns","classList","toggle","type","get_psp_type","call","is_numeric","float_val","user","_virtual_x","m","marked","Set","table","y","row","rows","tops","cells","style","backgroundColor","cell","xx","tx","ty","add","colSpan","rowSpan","has","tr","plugin","is_positive","is_negative","hex","color_mode","_plugin_background","foreground","color","max","min","abs","is_th","tagName","is_not_empty","value","toString","trim","is_leaf","next","dx","dy","y0","is_collapse","row_header","column_path","_column_paths","column_path_parts","split","_table_schema","sortHandler","meta","sort_method","shiftKey","append_sort","override_sort","CustomEvent","found","sort_term","_column_name","_sort_dir","term","create_sort","push","sort_dir","is_col_sortable","column_pivots","order","ROW_COL_SORT_ORDER","ROW_SORT_ORDER","inc_sort_dir","desc","asc","expandCollapseHandler","contains","_view","set_depth","filter","collapse","expand","_num_rows","num_rows","_num_columns","num_columns","mousedownListener","which","offsetX","stopImmediatePropagation","rect","getBoundingClientRect","clientY","top","get_min_max","unshift","preventDefault","clickListener","FORMATTERS","FORMATTER_CONS","datetime","Intl","DateTimeFormat","date","integer","NumberFormat","float","formatters","_format","parts","val","use_table_schema","title","is_plugin_override","formatter_key","type_config","get_type_config","opts","minimumFractionDigits","maximumFractionDigits","format","_tree_header","paths","row_headers","path","last","slice","fill","formatted","concat","dataListener","x0","x1","y1","to_columns","start_row","start_col","end_row","end_col","id","_ids","__ID__","data","column_headers","path_parts","column","map","__ROW_PATH__","get_rule","regular","tag","def","window","getComputedStyle","getPropertyValue","createModel","view","extend","get_config","expressions","expr","table_schema","validated_expressions","schema","expression_schema","column_paths","Promise","all","validate_expressions","model","_table","setDataListener","bind","configureRegularTable","addStyleListener","getCellConfig","row_idx","col_idx","to_json","row_paths","row_pivots_values","row_filters","pivot","index","pivot_value","column_index","keys","result","column_filters","column_pivot_values","column_names","filters","selected_rows_map","WeakMap","selectionListener","viewer","hasAttribute","handled","selected","get","key_match","reduce","agg","is_deselect","delete","set","bubbles","composed","selectionStyleListener","has_selected","querySelectorAll","th","configureRowSelectable","deselect","configureClick","selected_position_map","lock","body","args","resolve","apply","getPos","isContentEditable","_range","getSelection","getRangeAt","range","cloneRange","selectNodeContents","setEnd","endContainer","endOffset","selectionStart","write","active_cell","text","textContent","parseFloat","replace","isNaN","Date","parse","msg","__INDEX__","update","port_id","_edit_port","isEditable","has_pivots","selectable","editable","moveSelection","selected_position","xmin","xmax","ymin","ymax","focusStyleListener","scrollToCell","editableStyleListener","edit","toggleAttribute","tds","activeElement","focus","preventScroll","keydownListener","remove","keyCode","focusoutListener","selectedPosition","content","focusinListener","new_state","configureEditable","getEditPort","configureSortable","_preserve_focus_state","setAttribute","JSON","stringify","VIEWER_MAP","INSTALLED","datagridPlugin","is_installed","invalid_columns","scrollTop","scrollLeft","_resetAutoSize","get_or_create_datagrid","element","div","datagrid","innerHTML","appendChild","isConnected","clear","DatagridPlugin","create","resize","_datavis","save","restore","token","_register_global_styles","MATERIAL_STYLE","head","registerPlugin"],"mappings":"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"}