{"version":3,"sources":["../../../src/js/plugin/plugin.js"],"names":["registerPlugin","charts","PRIVATE","Symbol","DEFAULT_PLUGIN_SETTINGS","initial","type","count","selectMode","register","plugins","Set","length","map","chart","plugin","forEach","has","create","drawChart","resize","resizeChart","delete","deleteChart","save","restore","el","view","task","end_col","end_row","jsonp","metadata","realValues","JSON","parse","getAttribute","leaves_only","to_json","Promise","all","_table","schema","expression_schema","get_config","cancelled","table_schema","view_schema","json","config","get_pivot_column_type","column","columns","row_pivots","column_pivots","filter","filtered","reduce","acc","col","__ROW_PATH__","agg_paths","push","aggs","slice","rows","len","x","undefined","dataMap","i","mapped","settings","crossValues","r","name","mainValues","a","splitValues","data","createOrUpdateChart","call","setTimeout","getOrCreatePluginElement","perspective_d3fc_element","document","createElement","div","contains","innerHTML","appendChild","render","getSettings","setSettings","Element","prototype","matches","msMatchesSelector"],"mappings":"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","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport {registerPlugin} from \"@finos/perspective-viewer/src/js/utils.js\";\nimport charts from \"../charts/charts\";\nimport \"./polyfills/index\";\nimport \"./template\";\n\nexport const PRIVATE = Symbol(\"D3FC chart\");\n\nconst DEFAULT_PLUGIN_SETTINGS = {\n    initial: {\n        type: \"number\",\n        count: 1\n    },\n    selectMode: \"select\"\n};\n\nexport function register(...plugins) {\n    plugins = new Set(plugins.length > 0 ? plugins : charts.map(chart => chart.plugin.type));\n    charts.forEach(chart => {\n        if (plugins.has(chart.plugin.type)) {\n            registerPlugin(chart.plugin.type, {\n                ...DEFAULT_PLUGIN_SETTINGS,\n                ...chart.plugin,\n                create: drawChart(chart),\n                resize: resizeChart,\n                delete: deleteChart,\n                save,\n                restore\n            });\n        }\n    });\n}\n\nfunction drawChart(chart) {\n    return async function(el, view, task, end_col, end_row) {\n        let jsonp, metadata;\n        const realValues = JSON.parse(this.getAttribute(\"columns\"));\n        const leaves_only = chart.plugin.type !== \"d3_sunburst\";\n        if (end_col && end_row) {\n            jsonp = view.to_json({end_row, end_col, leaves_only});\n        } else if (end_col) {\n            jsonp = view.to_json({end_col, leaves_only});\n        } else if (end_row) {\n            jsonp = view.to_json({end_row, leaves_only});\n        } else {\n            jsonp = view.to_json({leaves_only});\n        }\n        metadata = await Promise.all([this._table.schema(false), view.expression_schema(false), view.schema(false), jsonp, view.get_config()]);\n\n        if (task.cancelled) {\n            return;\n        }\n\n        let [table_schema, expression_schema, view_schema, json, config] = metadata;\n\n        /**\n         * Retrieve a tree axis column from the table and expression schemas,\n         * returning a String type or `undefined`.\n         * @param {String} column a column name\n         */\n        const get_pivot_column_type = function(column) {\n            let type = table_schema[column];\n            if (!type) {\n                type = expression_schema[column];\n            }\n            return type;\n        };\n\n        const {columns, row_pivots, column_pivots, filter} = config;\n        const filtered =\n            row_pivots.length > 0\n                ? json.reduce(\n                      (acc, col) => {\n                          if (col.__ROW_PATH__ && col.__ROW_PATH__.length == row_pivots.length) {\n                              acc.agg_paths.push(acc.aggs.slice());\n                              acc.rows.push(col);\n                          } else {\n                              const len = col.__ROW_PATH__.filter(x => x !== undefined).length;\n                              acc.aggs[len] = col;\n                              acc.aggs = acc.aggs.slice(0, len + 1);\n                          }\n                          return acc;\n                      },\n                      {rows: [], aggs: [], agg_paths: []}\n                  )\n                : {rows: json};\n        const dataMap = (col, i) => (!row_pivots.length ? {...col, __ROW_PATH__: [i]} : col);\n        const mapped = filtered.rows.map(dataMap);\n\n        let settings = {\n            realValues,\n            crossValues: row_pivots.map(r => ({name: r, type: get_pivot_column_type(r)})),\n            mainValues: columns.map(a => ({name: a, type: view_schema[a]})),\n            splitValues: column_pivots.map(r => ({name: r, type: get_pivot_column_type(r)})),\n            filter,\n            data: mapped,\n            agg_paths: filtered.agg_paths\n        };\n\n        createOrUpdateChart.call(this, el, chart, settings);\n        await new Promise(setTimeout);\n    };\n}\n\nfunction getOrCreatePluginElement() {\n    let perspective_d3fc_element;\n    this[PRIVATE] = this[PRIVATE] || {};\n    if (!this[PRIVATE].chart) {\n        perspective_d3fc_element = this[PRIVATE].chart = document.createElement(\"perspective-d3fc-chart\");\n    } else {\n        perspective_d3fc_element = this[PRIVATE].chart;\n    }\n    return perspective_d3fc_element;\n}\n\nfunction createOrUpdateChart(div, chart, settings) {\n    const perspective_d3fc_element = getOrCreatePluginElement.call(this);\n\n    if (!div.contains(perspective_d3fc_element)) {\n        div.innerHTML = \"\";\n        div.appendChild(perspective_d3fc_element);\n    }\n\n    perspective_d3fc_element.render(chart, settings);\n}\n\nfunction resizeChart() {\n    if (this[PRIVATE] && this[PRIVATE].chart) {\n        const perspective_d3fc_element = this[PRIVATE].chart;\n        perspective_d3fc_element.resize();\n    }\n}\n\nfunction deleteChart() {\n    if (this[PRIVATE] && this[PRIVATE].chart) {\n        const perspective_d3fc_element = this[PRIVATE].chart;\n        perspective_d3fc_element.delete();\n    }\n}\n\nfunction save() {\n    if (this[PRIVATE] && this[PRIVATE].chart) {\n        const perspective_d3fc_element = this[PRIVATE].chart;\n        return perspective_d3fc_element.getSettings();\n    }\n}\n\nfunction restore(config) {\n    const perspective_d3fc_element = getOrCreatePluginElement.call(this);\n    perspective_d3fc_element.setSettings(config);\n}\n\nif (!Element.prototype.matches) {\n    Element.prototype.matches = Element.prototype.msMatchesSelector;\n}\n"],"file":"plugin.js"}