{"version":3,"sources":["../../../src/js/plugin/template.js"],"names":["d3","style","template","areArraysEqualSimple","initialiseStyles","bindTemplate","styleWithD3FC","getD3FCStyles","EXCLUDED_SETTINGS","D3FCChartElement","constructor","_chart","_settings","connectedCallback","_container","shadowRoot","querySelector","render","chart","settings","handler","set","obj","prop","value","includes","dispatchEvent","Event","bubbles","composed","Proxy","_configureSettings","data","length","plugin","type","remove","draw","window","navigator","userAgent","indexOf","setTimeout","containerDiv","select","chartClass","size","getBoundingClientRect","attr","resize","innerHTML","delete","getContainer","getSettings","forEach","s","setSettings","oldSettings","newSettings","oldValues","crossValues","mainValues","splitValues","realValues","newValues","agg_paths","colorStyles","headerStyles","document","querySelectorAll","d3fcStyles","innerText","push","join"],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,KAAKA,EAAZ,MAAoB,IAApB;AAEA,OAAOC,KAAP,MAAkB,uBAAlB;AACA,OAAOC,QAAP,MAAqB,4BAArB;AACA,SAAQC,oBAAR,QAAmC,gBAAnC;AACA,SAAQC,gBAAR,QAA+B,uBAA/B;AAEA,SAAQC,YAAR,QAA2B,wCAA3B;AAEA,MAAMC,aAAa,GAAI,GAAEL,KAAM,GAAEM,aAAa,EAAG,EAAjD;AACA,MAAMC,iBAAiB,GAAG,CAAC,aAAD,EAAgB,YAAhB,EAA8B,aAA9B,EAA6C,QAA7C,EAAuD,MAAvD,EAA+D,MAA/D,EAAuE,aAAvE,CAA1B;IAEuC;AACjCC,gB,WADLJ,YAAY,CAACH,QAAD,EAAWI,aAAX,C,gBAAb,MACMG,gBADN,wBAC2C;AACvCC,EAAAA,WAAW,GAAG;AACV;AACA,SAAKC,MAAL,GAAc,IAAd;AACA,SAAKC,SAAL,GAAiB,IAAjB;AACH;;AAEDC,EAAAA,iBAAiB,GAAG;AAChB,SAAKC,UAAL,GAAkB,KAAKC,UAAL,CAAgBC,aAAhB,CAA8B,QAA9B,CAAlB;AACH;;AAEDC,EAAAA,MAAM,CAACC,KAAD,EAAQC,QAAR,EAAkB;AACpB,SAAKR,MAAL,GAAcO,KAAd;AAEA,UAAME,OAAO,GAAG;AACZC,MAAAA,GAAG,EAAE,CAACC,GAAD,EAAMC,IAAN,EAAYC,KAAZ,KAAsB;AACvB,YAAI,CAAChB,iBAAiB,CAACiB,QAAlB,CAA2BF,IAA3B,CAAL,EAAuC;AACnC,eAAKT,UAAL,IAAmB,KAAKA,UAAL,CAAgBY,aAAhB,CAA8B,IAAIC,KAAJ,CAAU,2BAAV,EAAuC;AAACC,YAAAA,OAAO,EAAE,IAAV;AAAgBC,YAAAA,QAAQ,EAAE;AAA1B,WAAvC,CAA9B,CAAnB;AACH;;AACDP,QAAAA,GAAG,CAACC,IAAD,CAAH,GAAYC,KAAZ;AACA,eAAO,IAAP;AACH;AAPW,KAAhB;AAUA,SAAKZ,SAAL,GAAiB,IAAIkB,KAAJ,CAAU,KAAKC,kBAAL,CAAwB,KAAKnB,SAA7B,EAAwCO,QAAxC,CAAV,EAA6DC,OAA7D,CAAjB;AACAhB,IAAAA,gBAAgB,CAAC,KAAKU,UAAN,EAAkB,KAAKF,SAAvB,CAAhB;;AAEA,QAAK,KAAKA,SAAL,CAAeoB,IAAf,IAAuB,KAAKpB,SAAL,CAAeoB,IAAf,CAAoBC,MAApB,GAA6B,CAArD,IAA2Df,KAAK,CAACgB,MAAN,CAAaC,IAAb,KAAsB,KAAKxB,MAAL,CAAYuB,MAAZ,CAAmBC,IAAxG,EAA8G;AAC1G,WAAKC,MAAL;AACH;;AACD,SAAKC,IAAL;;AAEA,QAAIC,MAAM,CAACC,SAAP,CAAiBC,SAAjB,CAA2BC,OAA3B,CAAmC,MAAnC,IAA6C,CAAC,CAAlD,EAAqD;AACjD;AACA;AACAC,MAAAA,UAAU,CAAC,MAAM,KAAKL,IAAL,EAAP,CAAV;AACH;AACJ;;AAEDA,EAAAA,IAAI,GAAG;AACH,QAAI,KAAKzB,SAAL,CAAeoB,IAAnB,EAAyB;AACrB,YAAMW,YAAY,GAAG3C,EAAE,CAAC4C,MAAH,CAAU,KAAK9B,UAAf,CAArB;AACA,YAAM+B,UAAU,GAAI,SAAQ,KAAKlC,MAAL,CAAYuB,MAAZ,CAAmBC,IAAK,EAApD;AACA,WAAKvB,SAAL,CAAekC,IAAf,GAAsB,KAAKhC,UAAL,CAAgBiC,qBAAhB,EAAtB;;AAEA,UAAI,KAAKnC,SAAL,CAAeoB,IAAf,CAAoBC,MAApB,GAA6B,CAAjC,EAAoC;AAChC,aAAKtB,MAAL,CAAYgC,YAAY,CAACK,IAAb,CAAkB,OAAlB,EAA2BH,UAA3B,CAAZ,EAAoD,KAAKjC,SAAzD;AACH,OAFD,MAEO;AACH+B,QAAAA,YAAY,CAACK,IAAb,CAAkB,OAAlB,EAA4B,GAAEH,UAAW,WAAzC;AACH;AACJ;AACJ;;AAEDI,EAAAA,MAAM,GAAG;AACL,SAAKZ,IAAL;AACH;;AAEDD,EAAAA,MAAM,GAAG;AACL,SAAKtB,UAAL,CAAgBoC,SAAhB,GAA4B,EAA5B;AACH;;AAEDC,EAAAA,MAAM,GAAG;AACL,SAAKf,MAAL;AACH;;AAEDgB,EAAAA,YAAY,GAAG;AACX,WAAO,KAAKtC,UAAZ;AACH;;AAEDuC,EAAAA,WAAW,GAAG;AACV,UAAMlC,QAAQ,GAAG,EAAC,GAAG,KAAKP;AAAT,KAAjB;AACAJ,IAAAA,iBAAiB,CAAC8C,OAAlB,CAA0BC,CAAC,IAAI;AAC3B,aAAOpC,QAAQ,CAACoC,CAAD,CAAf;AACH,KAFD;AAGA,WAAOpC,QAAP;AACH;;AAEDqC,EAAAA,WAAW,CAACrC,QAAD,EAAW;AAClB,SAAKP,SAAL,GAAiB,EAAC,GAAG,KAAKA,SAAT;AAAoB,SAAGO;AAAvB,KAAjB;AACA,SAAKkB,IAAL;AACH;;AAEDN,EAAAA,kBAAkB,CAAC0B,WAAD,EAAcC,WAAd,EAA2B;AACzC,QAAID,WAAJ,EAAiB;AACb,UAAI,CAACA,WAAW,CAACzB,IAAjB,EAAuB;AACnB;AACA,eAAO,EAAC,GAAGyB,WAAJ;AAAiB,aAAGC;AAApB,SAAP;AACH;;AAED,YAAMC,SAAS,GAAG,CAACF,WAAW,CAACG,WAAb,EAA0BH,WAAW,CAACI,UAAtC,EAAkDJ,WAAW,CAACK,WAA9D,EAA2EL,WAAW,CAACM,UAAvF,CAAlB;AACA,YAAMC,SAAS,GAAG,CAACN,WAAW,CAACE,WAAb,EAA0BF,WAAW,CAACG,UAAtC,EAAkDH,WAAW,CAACI,WAA9D,EAA2EJ,WAAW,CAACK,UAAvF,CAAlB;AACA,UAAI5D,oBAAoB,CAACwD,SAAD,EAAYK,SAAZ,CAAxB,EAAgD,OAAO,EAAC,GAAGP,WAAJ;AAAiBzB,QAAAA,IAAI,EAAE0B,WAAW,CAAC1B,IAAnC;AAAyCiC,QAAAA,SAAS,EAAEP,WAAW,CAACO,SAAhE;AAA2EC,QAAAA,WAAW,EAAE;AAAxF,OAAP;AACnD;;AACD,SAAK9B,MAAL;AACA,WAAOsB,WAAP;AACH;;AA/FsC,C;;AAkG3C,SAASnD,aAAT,GAAyB;AACrB,QAAM4D,YAAY,GAAGC,QAAQ,CAACpD,aAAT,CAAuB,MAAvB,EAA+BqD,gBAA/B,CAAgD,OAAhD,CAArB;AACA,QAAMC,UAAU,GAAG,EAAnB;AACAH,EAAAA,YAAY,CAACb,OAAb,CAAqBC,CAAC,IAAI;AACtB,QAAIA,CAAC,CAACgB,SAAF,CAAY9B,OAAZ,CAAoB,OAApB,MAAiC,CAAC,CAAtC,EAAyC;AACrC6B,MAAAA,UAAU,CAACE,IAAX,CAAgBjB,CAAC,CAACgB,SAAlB;AACH;AACJ,GAJD;AAKA,SAAOD,UAAU,CAACG,IAAX,CAAgB,EAAhB,CAAP;AACH","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\nimport * as d3 from \"d3\";\n\nimport style from \"../../less/chart.less\";\nimport template from \"../../html/d3fc-chart.html\";\nimport {areArraysEqualSimple} from \"../utils/utils\";\nimport {initialiseStyles} from \"../series/colorStyles\";\n\nimport {bindTemplate} from \"@finos/perspective-viewer/src/js/utils\";\n\nconst styleWithD3FC = `${style}${getD3FCStyles()}`;\nconst EXCLUDED_SETTINGS = [\"crossValues\", \"mainValues\", \"splitValues\", \"filter\", \"data\", \"size\", \"colorStyles\"];\n\n@bindTemplate(template, styleWithD3FC) // eslint-disable-next-line no-unused-vars\nclass D3FCChartElement extends HTMLElement {\n    constructor() {\n        super();\n        this._chart = null;\n        this._settings = null;\n    }\n\n    connectedCallback() {\n        this._container = this.shadowRoot.querySelector(\".chart\");\n    }\n\n    render(chart, settings) {\n        this._chart = chart;\n\n        const handler = {\n            set: (obj, prop, value) => {\n                if (!EXCLUDED_SETTINGS.includes(prop)) {\n                    this._container && this._container.dispatchEvent(new Event(\"perspective-plugin-update\", {bubbles: true, composed: true}));\n                }\n                obj[prop] = value;\n                return true;\n            }\n        };\n\n        this._settings = new Proxy(this._configureSettings(this._settings, settings), handler);\n        initialiseStyles(this._container, this._settings);\n\n        if ((this._settings.data && this._settings.data.length > 0) || chart.plugin.type !== this._chart.plugin.type) {\n            this.remove();\n        }\n        this.draw();\n\n        if (window.navigator.userAgent.indexOf(\"Edge\") > -1) {\n            // Workaround for MS Edge issue that doesn't draw content in the\n            // plot-area until the chart D3 object is redrawn\n            setTimeout(() => this.draw());\n        }\n    }\n\n    draw() {\n        if (this._settings.data) {\n            const containerDiv = d3.select(this._container);\n            const chartClass = `chart ${this._chart.plugin.type}`;\n            this._settings.size = this._container.getBoundingClientRect();\n\n            if (this._settings.data.length > 0) {\n                this._chart(containerDiv.attr(\"class\", chartClass), this._settings);\n            } else {\n                containerDiv.attr(\"class\", `${chartClass} disabled`);\n            }\n        }\n    }\n\n    resize() {\n        this.draw();\n    }\n\n    remove() {\n        this._container.innerHTML = \"\";\n    }\n\n    delete() {\n        this.remove();\n    }\n\n    getContainer() {\n        return this._container;\n    }\n\n    getSettings() {\n        const settings = {...this._settings};\n        EXCLUDED_SETTINGS.forEach(s => {\n            delete settings[s];\n        });\n        return settings;\n    }\n\n    setSettings(settings) {\n        this._settings = {...this._settings, ...settings};\n        this.draw();\n    }\n\n    _configureSettings(oldSettings, newSettings) {\n        if (oldSettings) {\n            if (!oldSettings.data) {\n                // Combine with the restored settings\n                return {...oldSettings, ...newSettings};\n            }\n\n            const oldValues = [oldSettings.crossValues, oldSettings.mainValues, oldSettings.splitValues, oldSettings.realValues];\n            const newValues = [newSettings.crossValues, newSettings.mainValues, newSettings.splitValues, newSettings.realValues];\n            if (areArraysEqualSimple(oldValues, newValues)) return {...oldSettings, data: newSettings.data, agg_paths: newSettings.agg_paths, colorStyles: null};\n        }\n        this.remove();\n        return newSettings;\n    }\n}\n\nfunction getD3FCStyles() {\n    const headerStyles = document.querySelector(\"head\").querySelectorAll(\"style\");\n    const d3fcStyles = [];\n    headerStyles.forEach(s => {\n        if (s.innerText.indexOf(\"d3fc-\") !== -1) {\n            d3fcStyles.push(s.innerText);\n        }\n    });\n    return d3fcStyles.join(\"\");\n}\n"],"file":"template.js"}